{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Craftics Cart</title>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="overflow-x-hidden px-4 md:px-8 pb-8 pt-24 min-h-screen bg-yellow-100 flex flex-col justify-between">
  
  <!-- Carousel Section -->
  <div class="flex justify-center mb-8 relative">
    <div class="w-full max-w-4xl overflow-hidden relative border-4 border-pink-600 rounded-lg">
      <!-- Container Carousel -->
      <div id="carousel" class="flex transition-transform duration-500 ease-in-out w-[300%]">
        <img src="{% static 'image/car-1.png' %}" alt="Carousel 1" class="w-[100%] h-[450px] object-cover rounded-lg">
        <img src="{% static 'image/car-2.png' %}" alt="Carousel 2" class="w-[100%] h-[450px] object-cover rounded-lg">
        <img src="{% static 'image/car-3.png' %}" alt="Carousel 3" class="w-[100%] h-[450px] object-cover rounded-lg">
      </div>

      <!-- Tombol Geser Kiri -->
      <button id="prevBtn" class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white bg-opacity-50 text-gray-700 rounded-full p-3 z-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M15.293 7.293a1 1 0 011.414 1.414L10.414 15l6.293 6.293a1 1 0 01-1.414 1.414l-7-7a1 1 0 010-1.414l7-7z" clip-rule="evenodd" />
        </svg>
      </button>

      <!-- Tombol Geser Kanan -->
      <button id="nextBtn" class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white bg-opacity-50 text-gray-700 rounded-full p-3 z-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
          <path fill-rule="evenodd" d="M8.707 16.707a1 1 0 01-1.414-1.414L13.586 9l-6.293-6.293a1 1 0 111.414-1.414l7 7a1 1 0 010 1.414l-7 7z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Craft Section -->
  <div class="flex flex-col items-center justify-center mb-8">
    <div id="craft_entry_cards"></div>
    <div id="crudModal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 overflow-x-hidden overflow-y-auto transition-opacity duration-300 ease-out">
      <div id="crudModalContent" class="relative bg-white rounded-lg shadow-lg w-5/6 sm:w-3/4 md:w-1/2 lg:w-1/3 mx-4 sm:mx-0 transform scale-95 opacity-0 transition-transform transition-opacity duration-300 ease-out">
        <!-- Modal header -->
        <div class="flex items-center justify-between p-4 border-b rounded-t">
          <h3 class="text-xl font-semibold text-gray-900">
            Add New Craft Entry
          </h3>
          <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" id="closeModalBtn">
            <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <!-- Modal body -->
        <div class="px-6 py-4 space-y-6 form-style">
          <form id="craftEntryForm">
            <div class="mb-4">
              <label for="name" class="block text-sm font-medium text-gray-700">Craft Name</label>
              <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md p-2 hover:border-pink-500" placeholder="Enter craft name" required>
            </div>

            <div class="mb-4">
              <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
              <textarea id="description" name="description" rows="3" class="mt-1 block w-full h-52 resize-none border border-gray-300 rounded-md p-2 hover:border-pink-500" placeholder="Describe the craft" required></textarea>
            </div>

            <div class="mb-4">
              <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
              <input type="number" id="price" name="price" min="1" step="0.01" class="mt-1 block w-full border border-gray-300 rounded-md p-2 hover:border-pink-500" placeholder="Enter craft price" required>
            </div>

            <!-- New Image URL Input -->
            <div class="mb-4">
              <label for="image_url" class="block text-sm font-medium text-gray-700">Image URL</label>
              <input type="url" id="image_url" name="image_url" class="mt-1 block w-full border border-gray-300 rounded-md p-2 hover:border-pink-500" placeholder="Enter image URL">
            </div>
          </form>
        </div>

        <!-- Modal footer -->
        <div class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-2 p-6 border-t border-gray-200 rounded-b justify-center md:justify-end">
          <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" id="cancelButton">Cancel</button>
          <button type="submit" id="submitCraftEntry" form="craftEntryForm" class="bg-pink-600 hover:bg-pink-500 text-white font-bold py-2 px-4 rounded-lg">Save</button>
        </div>
      </div>
    </div>
   <!-- Nama dan Kelas di Bawah "+" Button -->
    <div class="text-center mt-6">
      <a href="{% url 'main:create_craft_entry' %}" class="relative group inline-block">
        <div class="flex items-center justify-center w-16 h-16 bg-pink-500 text-white rounded-full shadow-lg transition-all duration-300 transform group-hover:w-32 group-hover:bg-yellow-500 group-hover:scale-110">
          <span class="text-2xl font-bold group-hover:hidden">+</span>
          <span class="hidden group-hover:inline font-bold">Add Craft</span>
        </div>
      </a>
    </div>

    <!-- Add Craft by AJAX Button -->
    <div class="text-center mt-6">
      <div class="relative group inline-block">
        <div class="flex items-center justify-center w-16 h-16 bg-pink-500 text-white rounded-full shadow-lg transition-all duration-300 transform group-hover:w-32 group-hover:bg-yellow-500 group-hover:scale-110" onclick="showModal();">
          <span class="text-2xl font-bold group-hover:hidden">+</span>
          <span class="hidden group-hover:inline font-bold">Add Craft by AJAX</span>
        </div>
      </div>
    </div>


  <!-- Card Section -->
  <!-- <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 px-4 sm:px-6 lg:px-8">
    {% if craft_entries %}
      {% for craft_entry in craft_entries %}
        {% include 'card_craft.html' with craft_entry=craft_entry %}
      {% endfor %}
    {% endif %}
  </div> -->

  <!-- Timestamp di Paling Bawah -->
  <div class="text-center mt-8">
    <p class="text-gray-400 text-sm italic">Last Login: {{ last_login }}</p> <!-- Timestamp dengan sheer color -->
  </div>

  <!-- Nama dan Kelas -->
  <div class="text-center mt-6">
    <p class="text-pink-500 text-lg font-semibold"> &COPY; {{ nama }} || {{ kelas }}</p>
  </div>
</div>

<!-- Script Carousel -->
<script>
  const carousel = document.getElementById('carousel');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  let currentIndex = 0;

  // Total slides (jumlah gambar dalam carousel)
  const totalSlides = carousel.children.length;

  // Lebar per slide
  const slideWidth = carousel.children[0].clientWidth;

  // Geser ke kiri
  prevBtn.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      carousel.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
    }
  });

  // Geser ke kanan
  nextBtn.addEventListener('click', () => {
    if (currentIndex < totalSlides - 1) {
      currentIndex++;
      carousel.style.transform = `translateX(-${currentIndex * slideWidth}px)`;
    }
  });
</script>

<script>
  // Fetch the list of craft entries as JSON
  async function getCraftEntries(){
      // Replace 'main:craft_entries_json' with the appropriate URL name in your Django urls.py
      return fetch("{% url 'main:show_json' %}").then((res) => res.json());
  }

  async function refreshCraftEntries() {
    document.getElementById("craft_entry_cards").innerHTML = "";
    document.getElementById("craft_entry_cards").className = "";
    const craftEntries = await getCraftEntries(); // Assuming getCraftEntries is already defined to fetch the craft entries.
    let htmlString = "";
    let classNameString = "";

    if (craftEntries.length === 0) {
        classNameString = "flex flex-col items-center justify-center min-h-[24rem] p-6";
        htmlString = `
            <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
                <img src="{% static 'image/bow.png' %}" alt="Sad face" class="w-32 h-32 mb-4"/>
                <p class="text-center text-gray-600 mt-4">No crafts available in Craftics Cart.</p>
            </div>
        `;
    }
    else {
      classNameString = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 w-full"; // Reduced gap for smaller cards
      craftEntries.forEach((item) => {
        const name = DOMPurify.sanitize(item.fields.name);  // Sanitize the craft name
        const description = DOMPurify.sanitize(item.fields.description);  // Sanitize the craft description
          htmlString += `
          <div class="hover-shine bg-white rounded-lg shadow-lg p-1 mb-3 w-full max-w-[10rem] mx-auto border-2 border-pink-500">
              <!-- Image Section (Square) -->
              <div class="w-full h-auto aspect-square bg-pink-500 overflow-hidden rounded-lg mb-2">
                  <img src="${item.fields.image_url ? item.fields.image_url : '{% static "image/default-card.png" %}'}" alt="Craft Image" class="w-full h-full object-cover">
              </div>
              
              <!-- Name of Craft -->
              <div class="text-center px-1">
                  <h3 class="text-pink-500 text-sm font-bold mb-1">${item.fields.name}</h3>
                  
                  <!-- Description -->
                  <p class="text-pink-500 text-xs italic mb-1">
                      "${item.fields.description}"
                  </p>
              </div>

              <!-- Price Section -->
              <div class="flex justify-center mt-2">
                  <div class="bg-pink-500 text-white py-1 px-2 rounded-full font-bold text-xs">
                      Price: $${item.fields.price}
                  </div>
              </div>

              <!-- Edit and Delete Buttons -->
              <div class="flex justify-center space-x-2 mt-2">
                  <a href="/edit-craft/${item.pk}" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded-full px-2 py-1 transition duration-300 shadow-md text-xs">
                      Edit
                  </a>
                  <a href="/delete/${item.pk}" class="bg-red-500 hover:bg-red-600 text-white rounded-full px-2 py-1 transition duration-300 shadow-md text-xs">
                      Delete
                  </a>
              </div>
          </div>
          `;
      });

    }
    document.getElementById("craft_entry_cards").className = classNameString;
    document.getElementById("craft_entry_cards").innerHTML = htmlString;
  }

  refreshCraftEntries();  // Call the function to load the entries

  const modal = document.getElementById('crudModal');
  const modalContent = document.getElementById('crudModalContent');

  function showModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      // Display the modal
      modal.classList.remove('hidden');
      setTimeout(() => {
          // Animate the modal content
          modalContent.classList.remove('opacity-0', 'scale-95');
          modalContent.classList.add('opacity-100', 'scale-100');
      }, 50); 
  }

  function hideModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      // Reverse the animation before hiding the modal
      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');

      setTimeout(() => {
          // Hide the modal completely after the animation
          modal.classList.add('hidden');
      }, 150); 
  }

  // Add event listeners to hide modal on button clicks
  document.getElementById("cancelButton").addEventListener("click", hideModal);
  document.getElementById("closeModalBtn").addEventListener("click", hideModal);

  function addCraftEntry() {
    fetch("{% url 'main:add_craft_entry_ajax' %}", {
      method: "POST",
      body: new FormData(document.querySelector('#craftEntryForm')),  // Menggunakan form untuk Craft Entry
    })
    .then(response => refreshCraftEntries())  // Refresh daftar craft setelah craft ditambahkan

    // Reset form setelah submit berhasil
    document.getElementById("craftEntryForm").reset(); 

    // Tutup modal setelah penambahan item
    document.querySelector("[data-modal-toggle='crudModal']").click();

    return false;  // Mencegah default form submission
}

// Menghubungkan event submit dengan fungsi addCraftEntry
// document.getElementById("submitCraftEntry").onclick = addCraftEntry;
document.getElementById("craftEntryForm").addEventListener("submit", (e) => {
    e.preventDefault();
    addCraftEntry();
  })

</script>

{% endblock content %}